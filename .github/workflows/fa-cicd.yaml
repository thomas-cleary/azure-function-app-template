name: 'Function App - CI/CD'

on:
  push:
    paths:
      - 'src/**'
      - '.github/**/fa**.yaml'

  workflow_dispatch:

env:
  PROJECT_KEY: afat

jobs:
  map_env_vars:
    runs-on: ubuntu-latest
    outputs:
      project_key: ${{ steps.step1.outputs.project_key }}
    steps:
      - name: Map env vars to output vars for reusable workflows
        id: step1
        run: |
          echo "project key: $PROJECT_KEY"
          echo "::set-output name=project_key::$PROJECT_KEY"

  deploy_dev:
    name: Deploy to DEV
    needs: map_env_vars
    uses: ./.github/workflows/fa-deploy.yaml
    with:
      gha_env: DEV
      env_key: dev
      project_key: ${{ needs.map_env_vars.outputs.project_key }}
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}

  deploy_test:
    name: Deploy to TEST
    if: github.ref_name == 'main'
    needs: deploy_dev
    uses: ./.github/workflows/fa-deploy.yaml
    with:
      gha_env: TEST
      env_key: test
      project_key: ${{ needs.map_env_vars.outputs.project_key }}
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}

  deploy_prd:
    name: Deploy to PRD
    needs: deploy_test
    uses: ./.github/workflows/fa-deploy.yaml
    with:
      gha_env: PRD
      env_key: prd
      project_key: ${{ needs.map_env_vars.outputs.project_key }}
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
